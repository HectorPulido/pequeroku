<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Micro-IDE</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }

        #editor-modal {
            position: fixed;
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #ddd;
            display: flex;
            border: 2px solid #444;
            overflow: hidden;
        }

        .sidebar {
            width: 200px;
            background: #2d2d2d;
            padding: 8px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li {
            padding: 4px 8px;
            cursor: pointer;
        }

        .sidebar li:hover {
            background: #3e3e3e;
        }

        .sidebar li.directory::before {
            content: 'üìÅ ';
        }

        .sidebar li.file::before {
            content: 'üìÑ ';
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        wc-monaco-editor {
            flex: 1;
        }

        .toolbar {
            background: #2d2d2d;
            padding: 4px;
            display: flex;
            gap: 4px;
        }

        .console {
            height: 150px;
            background: #1e1e1e;
            color: #eee;
            padding: 4px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .console-input {
            flex: 1;
        }

        .sidebar ul ul {
            padding-left: 12px;
        }

        button,
        input[type="text"] {
            background: #3e3e3e;
            color: #eee;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 8px;
        }
    </style>
    <!-- Monaco web-component -->
    <script type="module" src="https://cdn.jsdelivr.net/gh/vanillawc/wc-monaco-editor@1/index.js"></script>
</head>

<body>
    <div id="editor-modal">
        <div class="sidebar">
            <div><button id="refresh-tree">Refresh</button></div>
            <div><button id="new-folder">New Folder</button></div>
            <div><button id="new-file">New File</button></div>
            <ul id="file-tree"></ul>
        </div>
        <div class="main">
            <div class="toolbar">
                <button id="save-file">Save</button>
                <button id="run-code">Run (Python)</button>
                <button id="restart-container">Restart container</button>
                <button id="upload-file">Upload file</button>
                <span id="current_path_label"></span>
            </div>
            <wc-monaco-editor id="editor" language="python" theme="vs-dark" word-wrap="true"></wc-monaco-editor>
            <div class="console" id="console-log"></div>
            <div class="toolbar">
                <input type="text" id="console-cmd" class="console-input" placeholder="bash command..." />
                <button id="send-cmd">Send</button>
            </div>
        </div>
    </div>
    <script>
        // ====== CONFIG ======
        const urlParams = new URLSearchParams(window.location.search);
        const containerId = urlParams.get('containerId');
        const apiBase = `/api/containers/${containerId}`;
        const pathLabel = document.getElementById('current_path_label');

        (async () => {
            await sleep(1 * 1000);
            await openFile("/app/readme.txt");
        })();

        let currentFilePath = null;
        function changePath(newPath) {
            currentFilePath = newPath;
            pathLabel.innerText = currentFilePath;
        }

        function getCSRF() {
            const match = document.cookie.match(/csrftoken=([^;]+)/);
            return match ? match[1] : "";
        }
        // ====== UTILS ======
        async function api(path, opts = {}) {
            opts.headers = { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() }
            const res = await fetch(apiBase + path, opts);
            if (!res.ok) {
                addAlert(await res.text(), "error");
            }
            return res.json();
        }

        // ====== FILE TREE ======
        async function listDir(path = '/app') {
            return api(`/list_dir?path=${encodeURIComponent(path)}`);
        }

        /**
         * Carga hijos directos de 'path' en el <ul> dado
         */
        async function loadDir(path, ul) {
            ul.innerHTML = '';
            const items = await listDir(path);
            const prefix = path.replace(/\/$/, '') + '/';
            const direct = items.filter(item => {
                if (!item.path.startsWith(prefix)) return false;
                const rel = item.path.slice(prefix.length);
                return rel && !rel.includes('/');
            });
            direct.sort((a, b) => a.type === b.type ? a.name.localeCompare(b.name) : a.type === 'directory' ? -1 : 1);
            direct.forEach(item => {
                const li = document.createElement('li');
                li.classList.add(item.type);
                li.textContent = item.name;
                li.dataset.path = item.path;
                if (item.type === 'directory') {
                    li.addEventListener('click', async e => {
                        e.stopPropagation();
                        const isExp = li.classList.toggle('expanded');
                        if (isExp) {
                            const subUl = document.createElement('ul');
                            li.appendChild(subUl);
                            await loadDir(item.path, subUl);
                        } else {
                            const subUl = li.querySelector('ul');
                            if (subUl) li.removeChild(subUl);
                        }
                    });
                } else {
                    li.addEventListener('click', e => {
                        e.stopPropagation();
                        openFile(item.path);
                    });
                }
                ul.appendChild(li);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        document.getElementById('refresh-tree').addEventListener('click', () => {
            const root = document.getElementById('file-tree');
            loadDir('/app', root);
        });

        document.getElementById('save-file').addEventListener('click', async () => {
            if (!currentFilePath) return alert('Open a file first');
            const content = document.getElementById('editor').value;
            await api('/write_file/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: currentFilePath, content })
            });
        });

        // ====== CREATE FOLDER & FILE ======
        document.getElementById('new-folder').addEventListener('click', async () => {
            const name = prompt('Folder name:'); if (!name) return;
            const path = `/app/${name}`;
            await api('/create_dir/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path }) });
            document.getElementById('refresh-tree').click();
        });
        document.getElementById('new-file').addEventListener('click', async () => {
            const name = prompt('File name:'); if (!name) return;
            changePath(`/app/${name}`)
            document.getElementById('editor').value = '';
            document.getElementById('save-file').click();
            document.getElementById('refresh-tree').click();
        });

        async function openFile(path) {
            const { content } = await api(`/read_file/?path=${encodeURIComponent(path)}`);
            document.getElementById('editor').value = content;
            changePath(path);
        }

        // ====== CONSOLE ======
        async function sendCommand(cmd) {
            await api('/send_command/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ command: cmd }) });
        }
        async function readLogs() {
            const { logs } = await api('/read_logs/');
            const cons = document.getElementById('console-log');
            cons.innerHTML = logs.map((l) => `<div>${l}</div>`).join("");
            cons.scrollTop = cons.scrollHeight;
        }
        document.getElementById('send-cmd').addEventListener('click', () => {
            const inp = document.getElementById('console-cmd');
            sendCommand(inp.value).then(() => inp.value = '');
        });
        setInterval(readLogs, 1000);

        // ====== RUN PYTHON CODE ======
        document.getElementById('run-code').addEventListener('click', async () => {
            if (currentFilePath) {
                // save before running
                document.getElementById('save-file').click();
                const cmd = `python ${currentFilePath}`;
                await sendCommand(cmd);
            } else {
                alert('Open or create a .py file first');
            }
        });

        document.getElementById('restart-container').addEventListener('click', async () => {
            await api('/restart_container/', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        });

        document.getElementById('console-cmd').addEventListener(
            "keydown",
            // biome-ignore lint/style/noCommaOperator: <explanation>
            (e) => e.key === "Enter" && (e.preventDefault(), document.getElementById('send-cmd').click()),
        );

        // INITIAL
        document.getElementById('refresh-tree').click();


    </script>
</body>

</html>